services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: viza-backend
    environment:
      SPRING_PROFILES_ACTIVE: dev
      SERVER_PORT: 8080
      # Permitir CORS para o frontend local
      CORS_ALLOWED_ORIGINS: http://localhost:5173,http://localhost:5174,http://localhost:5175
    ports:
      - "8080:8080"
    volumes:
      # Persistir banco H2 (arquivo) fora do container
      - ./data:/app/data
    restart: unless-stopped

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: viza-frontend
    environment:
      # O browser acessa via host, não via DNS interno do Docker
      VITE_API_URL: http://localhost:8080/api
      # Habilitar mocks no frontend para evitar falhas quando a API não estiver disponível
      VITE_USE_MOCKS: "true"
    ports:
      - "5173:5173"
    volumes:
      # Hot reload: monta o projeto no container
      - ./:/app
      # Evitar sobrescrever node_modules do container
      - /app/node_modules
    # Inicia o Vite após garantir que as dependências estejam instaladas (quando o volume /app/node_modules estiver vazio)
    command: sh -c "[ -d node_modules ] || npm ci --no-audit --no-fund; npm run dev -- --host 0.0.0.0"
    depends_on:
      - backend
    restart: unless-stopped

networks:
  default:
    name: viza-net